<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <!-- 
    代辦事項
    1. 新增ICD10搜尋功能
    2. 新增問診重點等文件下載
    3. 自動轉換成體重
    4. local storage
  -->

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NeoAssist</title>
  <!-- 引入 Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f1e6d8;
      font-family: 'Roboto', sans-serif;
      color: #333333;
    }

    .card {
      background-color: #faf9f8;
      margin-bottom: 10px;
    }

    .card-header {
      background-color: #333333;
      color: white;
    }

    .nav-tabs {
      display: flex;
      justify-content: space-between;
      border-color: #333333;
      /* 選項平均分配 */
    }

    .nav-tabs .nav-item {
      flex: 1;
      /* 每個項目占同等比例 */
      text-align: center;
      /* 文字置中 */
    }

    .nav-tabs .nav-link {
      color: #777777;
      width: 100%;
      /* 填滿父容器寬度 */
      text-align: center;
      /* 文字置中 */
      border-radius: 0%;
    }

    .nav-tabs .nav-link.active {
      background-color: #333333;
      border-color: #333333;
      color: white;
    }

    .nav-tabs .nav-link:hover {
      border-color: #333333;
    }

    .input-group {
      margin-bottom: 5px;
    }

    /* .input-group-text {
      background-color: #f3ece4;
    } */

    /* 修改聚焦時的邊框顏色，並確保樣式優先級 */
    input:focus,
    textarea:focus,
    select:focus {
      border-color: #333333 !important;
      box-shadow: 0 0 0 0.2rem #333333 !important;
      /* 強制使用深棕色邊框陰影 */
    }

    /*把輸入框的上下箭頭移除*/
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number] {
      -moz-appearance: textfield;
    }

    /* 移除預設的向下箭頭 */
    .form-select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: none !important;
      padding-right: 0.75rem !important;
    }

    .copy-item {
      background-color: #faf9f8;
      border-color: #dee2e6;
      cursor: pointer;
    }

    .copy-item:hover,
    input:hover,
    .form-select:hover {
      background-color: #e9e7e5 !important;
      /* 統一的 Hover 顏色 */
      color: #333333;
      /* 保持文字顏色一致 */
    }
  </style>
</head>

<body>
  <!-- 分頁導航欄 -->
  <ul class="nav nav-tabs" id="mainTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="fluidTab" data-bs-toggle="tab" data-bs-target="#fluidContent" type="button"
        role="tab" aria-controls="fluidContent" aria-selected="true">
        水分計算
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="medicationTab" data-bs-toggle="tab" data-bs-target="#medicationContent" type="button"
        role="tab" aria-controls="medicationContent" aria-selected="false">
        藥物泡法
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="growthTab" data-bs-toggle="tab" data-bs-target="#growthContent" type="button"
        role="tab" aria-controls="growthContent" aria-selected="false">
        生長測量
      </button>
    </li>
  </ul>

  <!-- 分頁內容區域 -->
  <div class="tab-content" id="mainTabContent">
    <!-- 分頁 1: 水分計算 -->
    <div class="tab-pane show active" id="fluidContent" role="tabpanel" aria-labelledby="fluidTab">
      <div class="container mt-4">
        <div class="row mb-3">
          <div class="col">
            <div class="card h-100">
              <div class="card-header text-center">水分計算</div>
              <div class="card-body pb-0">
                <div class="input-group">
                  <span class="input-group-text justify-content-center" style="width: 15%;">BW</span>
                  <input type="number" id="fluid_BW" class="form-control text-center" oninput="calculateFluid()" />
                  <span class="input-group-text  justify-content-center" style="width: 15%;">g</span>
                </div>
                <div class="input-group">
                  <span class="input-group-text justify-content-center" style="width: 15%;">TDF</span>
                  <input type="number" id="fluid_TDF" class="form-control text-center" oninput="calculateFluid()" />
                  <span class="input-group-text  justify-content-center" style="width: 15%;">ml/kg/day</span>
                </div>
                <div class="input-group">
                  <span class="input-group-text justify-content-center" style="width: 15%;">PO</span>
                  <select id="fluid_PO_HM" class="form-select text-center" onchange="calculateFluid()">
                    <option value=""></option>
                    <option value="HM" selected>HM</option>
                  </select>
                  <span class="input-group-text" style="background-color: #ffffff;">/</span>
                  <select id="fluid_PO_formula" class="form-select text-center" onchange="calculateFluid()">
                    <option value=""></option>
                    <option value="16%PF" selected>16%PF</option>
                    <option value="15%PDF">15%PDF</option>
                    <option value="14%RF">14%RF</option>
                  </select>
                  <input type="text" id="fluid_PO" class="form-control text-center" oninput="calculateFluid()" />
                  <span class="input-group-text  justify-content-center" style="width: 15%;">ml/day</span>
                </div>
                <div class="input-group">
                  <span class="input-group-text justify-content-center" style="width: 15%;">TPN</span>
                  <select id="fluid_TPN_AA" class="form-select text-center" onchange="calculateFluid()">
                    <option value="0.025">AA 2.5</option>
                    <option value="0.030">AA 3.0</option>
                    <option value="0.033">AA 3.3</option>
                    <option value="0.035">AA 3.5</option>
                    <option value="0.040">AA 4.0</option>
                    <option value="0.050">AA 5.0</option>
                  </select>
                  <input type="number" id="fluid_TPN_grams" class="form-control text-center" oninput="calculateFluid()" />
                  <span class="input-group-text">g/kg/day</span>
                  <input type="number" id="fluid_TPN_hours" min="0" max="24" class="form-control text-center" placeholder="-" oninput="calculateFluid()" />
                  <span class="input-group-text  justify-content-center" style="width: 15%;">hrs</span>
                </div>
                <div class="input-group">
                  <span class="input-group-text justify-content-center" style="width: 15%;"></span>
                  <select id="fluid_TPN_dex" class="form-select text-center" onchange="calculateFluid()">
                    <option value="0.025">Dex 2.5</option>
                    <option value="0.05">Dex 5.0</option>
                    <option value="0.075">Dex 7.5</option>
                    <option value="0.1" selected>Dex 10.0</option>
                    <option value="0.125">Dex 12.5</option>
                    <option value="0.15">Dex 15.0</option>
                    <option value="0.175">Dex 17.5</option>
                    <option value="0.2">Dex 20.0</option>
                    <option value="0.225">Dex 22.5</option>
                    <option value="0.25">Dex 25.0</option>
                  </select>
                  <select id="fluid_TPN_Na" class="form-select text-center" onchange="calculateFluid()">
                    <option value="0" >Na  0</option>
                    <option value="10">Na 10</option>
                    <option value="20">Na 20</option>
                    <option value="30">Na 30</option>
                    <option value="40" selected>Na 40</option>
                    <option value="50">Na 50</option>
                    <option value="60">Na 60</option>
                    <option value="60">Na 70</option>
                    <option value="60">Na 80</option>
                  </select>
                  <select id="fluid_TPN_K" class="form-select text-center" onchange="calculateFluid()">
                    <option value="0" >K  0</option>
                    <option value="10">K 10</option>
                    <option value="20" selected>K 20</option>
                    <option value="30">K 30</option>
                    <option value="40">K 40</option>
                    <option value="50">K 50</option>
                    <option value="60">K 60</option>
                    <option value="70">K 70</option>
                    <option value="80">K 80</option>
                  </select>
                  <select id="fluid_TPN_Ca" class="form-select text-center" onchange="calculateFluid()">
                    <option value=""></option>
                    <option value="20" selected>Ca 20</option>
                    <option value="30">Ca 30</option>
                    <option value="40">Ca 40</option>
                  </select>
                  <select id="fluid_TPN_P" class="form-select text-center" onchange="calculateFluid()">
                    <option value="0">P 0</option>
                    <option value="6">P 6</option>
                    <option value="9" selected>P 9</option>
                    <option value="10">P 10</option>
                    <option value="13.5">P 13.5</option>
                    <option value="15">P 15</option>
                    <option value="20">P 20</option>
                  </select>
                  <select id="fluid_TPN_Mg" class="form-select text-center" onchange="calculateFluid()">
                    <option value="0">Mg 0</option>
                    <option value="2">Mg 2</option>
                    <option value="4" selected>Mg 4</option>
                  </select>
                  <span class="input-group-text  justify-content-center" style="width: 15%;"></span>
                </div>
                <div class="input-group">
                  <span class="input-group-text justify-content-center" style="width: 15%;">Lipid</span>
                  <select id="fluid_lipid_type" class="form-select text-center" onchange="calculateFluid()">
                    <option value="SMOF">SMOF</option>
                    <option value="Omegaven">Omegaven</option>
                  </select>
                  <input type="number" id="fluid_lipid_grams" class="form-control text-center" oninput="calculateFluid()" />
                  <span class="input-group-text">g/kg/day</span>
                  <input type="number" id="fluid_lipid_hours" min="16" max="24" class="form-control text-center" placeholder="-" oninput="calculateFluid()" />
                  <span class="input-group-text  justify-content-center" style="width: 15%;">hrs</span>
                </div>
                <div class="input-group">
                  <span class="input-group-text justify-content-center" style="width: 15%;">Other</span>
                  <select name="fluid_other_in_IO_base" class="form-select text-center" onchange="calculateFluid()">
                    <option value="" selected></option>
                    <option value="3% NaCl">3% NaCl</option>
                  </select>
                  <input type="text" name="fluid_other_in_IO" class="form-control text-center" oninput="calculateFluid()" />
                  <span class="input-group-text  justify-content-center" style="width: 10%;">ml/day</span>
                  <button class="btn btn-light" style="border-color: #e0e3e7; width: 5%;" onclick="addNewElement(this, 'fluid_other_in_IO')">+</button>
                </div>
                <div class="input-group">
                  <span class="input-group-text justify-content-center" style="width: 15%;">Other</span>
                  <select name="fluid_other_solution_base" class="form-select text-center" onchange="calculateFluid()">
                    <option value="" selected></option>
                    <option value="D/W">D/W base</option>
                    <option value="D5W">D5W base</option>
                    <option value="D10W">D10W base</option>
                    <option value="H/S">H/S base</option>
                    <option value="N/S">N/S base</option>
                    <option value="L/R">L/R base</option>
                  </select>
                  <input type="text" name="fluid_other_solution_rate" class="form-control text-center" oninput="calculateFluid()" />
                  <span class="input-group-text justify-content-center" style="width:10%">ml/hr</span>
                  <button class="btn btn-light" style="border-color: #e0e3e7; width: 5%;" onclick="addNewElement(this, 'fluid_other_solution')">+</button>
                </div>
                <div class="input-group">
                  <span class="input-group-text justify-content-center" style="width: 15%;">普通IV</span>
                  <select id="fluid_regular_IV_type" class="form-select text-center" onchange="calculateFluid()">
                    <option value=""></option>
                    <option value="D5W">D5W</option>
                    <option value="D10W">D10W</option>
                    <option value="D0.225S(500)">D0.225S(500)</option>
                    <option value="D0.225S(500) + 2PC D50W">D0.225S(500) + 2PC D50W</option>
                  </select>
                  <input type="number" id="fluid_regular_IV_rate" class="form-control text-center" oninput="calculateFluid()" />
                  <span class="input-group-text  justify-content-center" style="width: 15%;">ml/hr</span>
                </div>
              </div>
              <div class="card-footer">
                <!-- <div class="input-group d-flex mt-2 mb-2">
                  <span class="input-group-text justify-content-center text-truncate" style="width: 15%;">current BW</span>
                  <input type="text" class="form-control flex-fill text-center" placeholder="" id="fluid_BW_for_calculating_nutrition"/>
                  <span class="input-group-text justify-content-center" style="width: 5%">g</span>
                  <span class="input-group-text justify-content-center flex-fill"></span>
                  <span class="input-group-text copy-item flex-fill justify-content-center" id="fluid_nutrition_GIR">GIR</span>
                  <span class="input-group-text copy-item flex-fill justify-content-center" id="fluid_nutrition_Kcal">Kcal</span>
                </div> -->
                <div class="input-group d-flex mt-2 mb-2">
                  <span class="input-group-text flex-fill justify-content-center" id="fluid_nutrition_Na">Na ___</span>
                  <span class="input-group-text flex-fill justify-content-center" id="fluid_nutrition_K">K ___</span>
                  <span class="input-group-text flex-fill justify-content-center" id="fluid_nutrition_Ca">Ca ___</span>
                  <span class="input-group-text flex-fill justify-content-center" id="fluid_nutrition_P">P ___</span>
                  <span class="input-group-text flex-fill justify-content-center" id="fluid_nutrition_Mg">Mg ___</span>
                  <span class="input-group-text justify-content-center text-truncate" style="width: 15%;">/kg/day</span>
                </div>
                <ul class="list-group mt-2 mb-2">
                  <li class="list-group-item" style="background-color: #faf9f8;" id="fluid_order_output">Order</li>
                  <li class="list-group-item copy-item" name="fluid_order_outputs" data-content="BW:">BW:</li>
                  <li class="list-group-item copy-item" name="fluid_order_outputs" data-content="Total daily fluid:">Total daily fluid:</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="row mb-3">
          <div class="col">
            <div class="card h-100">
              <div class="card-header text-center">GIR計算</div>
              <div class="card-body pb-0">
                <div class="input-group">
                  <span class="input-group-text justify-content-center" style="width: 15%;">BW</span>
                  <input type="number" id="GIR_BW" class="form-control text-center" oninput="calculateGIR()" />
                  <span class="input-group-text  justify-content-center" style="width: 15%;">g</span>
                </div>
                <div class="input-group">
                  <span class="input-group-text justify-content-center" style="width: 15%;">Dex</span>
                  <input name="GIR_dex" type="number" class="form-control text-center" value="10" oninput="calculateGIR()">
                  <span class="input-group-text">%</span>
                  <input name="GIR_rate" type="text" class="form-control text-center" oninput="calculateGIR()">
                  <span class="input-group-text" style="width: 10%;">ml/hr</span>
                  <button class="btn btn-light" style="border-color: #e0e3e7; width: 5%;" onclick="addNewElement(this, 'GIR_dex')">+</button>
                </div>   
                <div class="input-group">
                  <span class="input-group-text justify-content-center" style="width: 15%;">Dex</span>
                  <input name="GIR_dex" type="number" class="form-control text-center" value="5" oninput="calculateGIR()">
                  <span class="input-group-text">%</span>
                  <input name="GIR_rate" type="text" class="form-control text-center" oninput="calculateGIR()">
                  <span class="input-group-text" style="width: 10%;">ml/hr</span>
                  <button class="btn btn-light" style="border-color: #e0e3e7; width: 5%;" onclick="addNewElement(this, 'GIR_dex')">+</button>
                </div>   
                <div class="input-group">
                  <span class="input-group-text justify-content-center" style="width: 15%;">Dex</span>
                  <input name="GIR_dex" type="number" class="form-control text-center" oninput="calculateGIR()">
                  <span class="input-group-text">%</span>
                  <input name="GIR_rate" type="text" class="form-control text-center" oninput="calculateGIR()">
                  <span class="input-group-text" style="width: 10%;">ml/hr</span>
                  <button class="btn btn-light" style="border-color: #e0e3e7; width: 5%;" onclick="addNewElement(this, 'GIR_dex')">+</button>
                </div>   
                <div class="input-group">
                  <span class="input-group-text justify-content-center" style="width: 15%;">Dex</span>
                  <input name="GIR_dex" type="number" class="form-control text-center" oninput="calculateGIR()">
                  <span class="input-group-text">%</span>
                  <input name="GIR_rate" type="text" class="form-control text-center" oninput="calculateGIR()">
                  <span class="input-group-text" style="width: 10%;">ml/hr</span>
                  <button class="btn btn-light" style="border-color: #e0e3e7; width: 5%;" onclick="addNewElement(this, 'GIR_dex')">+</button>
                </div>   
              </div>
              <div class="card-footer">
                <div class="input-group d-flex mt-2 mb-2">
                  <span class="input-group-text copy-item flex-fill justify-content-center" id="GIR_result">GIR 0.0</span>
                </div>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="card h-100">
              <div class="card-header text-center">普通點滴dextrose計算</div>
              <div class="card-body d-flex align-items-center pb-0">
                <div>
                  <div class="input-group">
                    <span class="input-group-text justify-content-center" style="width: 15%;">Dex</span>
                    <input type="number" id="dextrose_original_concentration" class="form-control text-center" value="5" oninput="calculateDex()" />
                    <span class="input-group-text  justify-content-center" style="width: 15%;">%</span>
                    <input type="number" id="dextrose_original_amount" class="form-control text-center" value="500" oninput="calculateDex()" />
                    <span class="input-group-text  justify-content-center" style="width: 15%;">ml</span>                  
                  </div>
                  <div class="input-group">
                    <span class="input-group-text justify-content-center w-100" style="background-color: transparent; border: 0cm;">+</span>          
                  </div>
                  <div class="input-group">
                    <span class="input-group-text justify-content-center" style="width: 15%;">Dex</span>
                    <input type="number" id="dextrose_add_concentration" class="form-control text-center" value="50" oninput="calculateDex()"/>
                    <span class="input-group-text  justify-content-center" style="width: 15%;">%</span>
                    <input type="number" id="dextrose_add_amount" class="form-control text-center" oninput="calculateDex()" />
                    <span class="input-group-text  justify-content-center" style="width: 15%;">ml</span>                  
                  </div>
                  <div class="input-group">
                    <span class="input-group-text justify-content-center w-100" style="background-color: transparent; border: 0cm;">| |</span>          
                  </div>
                </div>
              </div>
              <div class="card-footer">
                <div class="input-group d-flex mt-2 mb-2">
                  <span class="input-group-text copy-item flex-fill justify-content-center" id="dextrose_concentration_final">Dextrose = 0.00 %</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="row mb-4">
          <div class="col">
            <div class="card h-100">
              <div class="card-header text-center">UA、UV深度計算</div>
              <div class="card-body pb-0">
                <div class="input-group">
                  <span class="input-group-text justify-content-center" style="width: 15%;">BW</span>
                  <input type="number" id="umbilical_cath_len_BW" class="form-control text-center" oninput="calculateUmbilicalCathLen()" />
                  <span class="input-group-text  justify-content-center" style="width: 15%;">g</span>
                </div>
              </div>
              <div class="card-footer">
                <div>
                  <div class="row g-2">
                    <div class="col">
                      <div class="input-group d-flex mt-2 mb-2">
                        <span class="input-group-text justify-content-center" style="width:30%;">UA</span>
                        <span class="input-group-text copy-item flex-fill justify-content-center" id="umbilical_cath_len_UA"></span>
                      </div>
                    </div>
                    <div class="col">
                      <div class="input-group d-flex mt-2 mb-2">
                        <span class="input-group-text justify-content-center" style="width:30%;">UV</span>
                        <span class="input-group-text copy-item flex-fill justify-content-center" id="umbilical_cath_len_UV"></span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 分頁 2: 藥物泡法 -->
    <div class="tab-pane" id="medicationContent" role="tabpanel" aria-labelledby="medicationTab">
      <div class="container mt-4">
        <div class="row mb-3">
          <div class="col">
            <div class="card h-100">
              <div class="card-header text-center">藥物泡法</div>
              <div class="card-body pb-0">
                <div class="input-group">
                  <span class="input-group-text justify-content-center" style="width: 15%;">BW</span>
                  <input type="text" id="drug_BW" class="form-control text-center" oninput="calculateDrugPreperation()"/>
                  <span class="input-group-text justify-content-center" style="width: 15%;">kg</span>
                </div>
                <div class="input-group">
                  <span class="input-group-text justify-content-center" style="width: 15%;">Drug</span>
                  <select id="drug_name" class="form-select text-center" title="" onchange="calculateDrugPreperation()">
                    <option value="Dopamine"      >Dopamine       </option>
                    <option value="Dobutamine"    >Dobutamine     </option>
                    <option value="Milrinone"     >Milrinone      </option>
                    <option value="Epinephrine"   >Epinephrine    </option>
                    <option value="Midazolam"     >Midazolam      </option>
                    <option value="Fentanyl"      >Fentanyl       </option>
                    <option value="Bumetanide"    >Bumetanide     </option>
                    <option value="Norepinephrine">Norepinephrine </option>
                    <option value="Nicardipine"   >Nicardipine    </option>
                    <option value="Nitroglycerin" >Nitroglycerin  </option>
                    <option value="Labetalol"     >Labetalol      </option>
                    <option value="PGE1"          >PGE1           </option>
                    <option value="Vasopressin"   >Vasopressin    </option>
                    <option value="Isoproterenol" >Isoproterenol  </option>
                    <option value="Rocuronium"    >Rocuronium     </option>
                    <option value="Cisatracurium" >Cisatracurium  </option>
                    <option value="Morphine"      >Morphine       </option>
                    <option value="Lorazepam"     >Lorazepam      </option>
                    <option value="Ketamine"      >Ketamine       </option>
                    <option value="Propofol"      >Propofol       </option>
                    <option value="MgSO4"         >MgSO4          </option>
                    <option value="Lidocaine"     >Lidocaine      </option>
                    <!-- More options -->
                  </select>
                  <input type="text" id="drug_extract_amount" class="form-control text-center" oninput="calculateDrugPreperation()" />
                  <span class="input-group-text justify-content-center" style="width: 15%;" id="drug_extract_amount_unit">mg</span>
                </div>
                <div class="input-group">
                  <span class="input-group-text justify-content-center" style="width: 15%;">In</span>
                  <select id="drug_diluter_name" class="form-select text-center" onchange="calculateDrugPreperation()">
                    <option value="D5W">D5W</option>
                    <option value="N/S">N/S</option>
                    <option value="D/W">D/W</option>
                  </select>  
                  <span class="input-group-text justify-content-center">total</span>
                  <input type="number" id="drug_total_final_volume" class="form-control text-center" oninput="calculateDrugPreperation()" />
                  <span class="input-group-text justify-content-center" style="width: 15%;">ml</span>
                </div>
                <div class="input-group">
                  <span class="input-group-text justify-content-center" style="width: 15%;">Run</span>
                  <input type="text" id="drug_infusion_rate" class="form-control text-center" oninput="calculateDrugPreperation()" />
                  <span class="input-group-text justify-content-center">ml/hr</span>
                  <span class="input-group-text justify-content-center">=</span>
                  <input type="number" id="drug_infusion_final_rate" class="form-control text-center" oninput="calculateDrugPreperation()" />
                  <span class="input-group-text justify-content-center" id="drug_infusion_final_rate_unit">mcg/kg/min</span>
                </div>
              </div>
              <div class="card-footer">
                <ul class="list-group mt-2 mb-2">
                  <li class="list-group-item copy-item" id="drug_text_for_order">&nbsp;</li>
                  <li class="list-group-item copy-item" id="drug_text_for_med">&nbsp;</li>
                  <li class="list-group-item copy-item" id="drug_text_for_pure_line">&nbsp;</li>
                </ul>  
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 其他分頁內容保持不變 -->
    <!-- ... -->
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/10.0.0/math.min.js"></script>
  <script>
    //*****************************************
    //水分 水分計算 = 計算水分
    //*****************************************
    function calculateFluid() {

      //讀取輸入值
      const fluidBW = parseFloat(document.getElementById('fluid_BW').value) || 0;
      const fluidTDF = parseFloat(document.getElementById('fluid_TDF').value) || 0;
      const fluidPO = document.getElementById('fluid_PO').value;
      const fluidPOHM = document.getElementById('fluid_PO_HM').value;
      const fluidPOFormula = document.getElementById('fluid_PO_formula').value;
      const fluidTPNAA = document.getElementById('fluid_TPN_AA').value;
      let fluidTPNGrams = document.getElementById('fluid_TPN_grams').value;
      const fluidTPNHours = parseFloat(document.getElementById('fluid_TPN_hours').value) || 24;
      const fluidTPNDex = parseFloat(document.getElementById('fluid_TPN_dex').value) || 10;
      const fluidTPNNa = parseFloat(document.getElementById('fluid_TPN_Na').value) || 40;
      const fluidTPNK = parseFloat(document.getElementById('fluid_TPN_K').value) || 20;
      const fluidTPNCa = parseFloat(document.getElementById('fluid_TPN_Ca').value) || 20;
      const fluidTPNP = parseFloat(document.getElementById('fluid_TPN_P').value) || 9;
      const fluidTPNMg = parseFloat(document.getElementById('fluid_TPN_Mg').value) || 2;
      const fluidLipidType = document.getElementById('fluid_lipid_type').value;
      const fluidLipidGrams = parseFloat(document.getElementById('fluid_lipid_grams').value) || 0;
      const fluidLipidHours = parseFloat(document.getElementById('fluid_lipid_hours').value) || 20;
      let fluidOtherInIO = document.querySelectorAll('[name="fluid_other_in_IO"]');
      let fluidOtherInIOBase = document.querySelectorAll('[name="fluid_other_in_IO_base"]');
      // const fluidOtherInIO = document.getElementById('fluid_other_in_IO').value;
      let fluidOtherSolutionBase = document.querySelectorAll('[name="fluid_other_solution_base"]');
      let fluidOtherSolutionRate = document.querySelectorAll('[name="fluid_other_solution_rate"]');
      // const fluidOtherSolutionBase = document.getElementById('fluid_other_solution_base').value;
      // const fluidOtherSolutionRate = parseFloat(document.getElementById('fluid_other_solution_rate').value) || 0;
      const fluidRegularIVType = document.getElementById('fluid_regular_IV_type').value || "普通IV";
      let fluidRegularIVRate = parseFloat(document.getElementById('fluid_regular_IV_rate').value) || 0;
      

      let fluidTotalNa = 0;
      let fluidTotalK  = 0;
      let fluidTotalCa = 0;
      let fluidTotalP  = 0;
      let fluidTotalMg = 0;
      

      //設定SMOF密度
      const fluidLipidSpec = {
        "SMOF": {density: 1/5, unit: "g/ml"},
        "Omegaven": {density: 1/10, unit: "g/ml"}
      };

      //設定TPN配方說明
      const fluidTpnAAMap = {
        "0.025": "TPN",
        "0.030": "TPN [AA 3.0]",
        "0.033": "TPN [AA 3.3]",
        "0.035": "TPN [AA 3.5]",
        "0.040": "TPN [AA 4.0]",
        "0.050": "TPN [N0]"
      };

      // Only one of fluidTPNGrams and fluidRegularIVRate can be entered
      const fluidRegularIVRateDIV = document.getElementById('fluid_regular_IV_rate');
      const fluidTPNGramsDIV = document.getElementById('fluid_TPN_grams');
      if (fluidTPNGramsDIV.value !== "") {
        fluidRegularIVRateDIV.disabled = true;
      } else if (fluidRegularIVRateDIV.value !== "") {
        fluidTPNGramsDIV.disabled = true;
      } else {
        fluidRegularIVRateDIV.disabled = false;
        fluidTPNGramsDIV.disabled = false;
      }


      // *****************************************
      //               計算fluid過程
      // *****************************************
      console.log("***************開始水分計算***************")
      console.log(`BW: ${fluidBW} g`);
      //計算TDF總量
      let fluidTotalTDF = (fluidTDF*fluidBW/1000).toFixed(1);
      console.log(`Total daily fluid: ${fluidTDF} ml/kg/day = total ${fluidTotalTDF} ml/day`);
      //計算PO總量
      let fluidTotalPO = fluidPO === "" ? 0 : parseExpression(fluidPO);      
      console.log(`Diet: ${fluidTotalPO} ml/day`);
      //計算Lipid總量
      let fluidLipidTotalVolumeGoal = fluidLipidGrams*fluidBW/1000/fluidLipidSpec[fluidLipidType].density;
      let fluidLipidValidHours = Math.min(23, Math.max(16, fluidLipidHours)); //確保輸入值在16~23之間
      let fluidLipidRate = (fluidLipidTotalVolumeGoal/fluidLipidValidHours).toFixed(1)
      let fluidLipidTotalVolume = fluidLipidRate*fluidLipidValidHours;
      let fluidLipidMinDiff = Math.abs(fluidLipidTotalVolume-fluidLipidTotalVolumeGoal);
      let fluidLipidBestHour = fluidLipidValidHours;
      const fluidLipidAcceptedError = 0.5;
      const fluidLipidMaxHour = 23;
      for (let i=16; i<=fluidLipidValidHours && i<=fluidLipidMaxHour; i++){
        fluidLipidRate = (fluidLipidTotalVolumeGoal/i).toFixed(1);
        fluidLipidTotalVolume = fluidLipidRate*i;
        const fluidLipidTotalVolumeDiff = Math.abs(fluidLipidTotalVolume-fluidLipidTotalVolumeGoal);
        if (fluidLipidTotalVolumeDiff<fluidLipidMinDiff || fluidLipidTotalVolumeDiff < fluidLipidAcceptedError){
          fluidLipidMinDiff=fluidLipidTotalVolumeDiff;
          fluidLipidBestHour=i;
        }
        // console.log(`target ${fluidLipidTotalVolumeGoal}, current ${fluidLipidTotalVolume}, current hr ${i}`);
        // console.log(`minDiff ${fluidLipidMinDiff.toFixed(1)}, bestHour = ${fluidLipidBestHour}`);
      }
      fluidLipidRate = (fluidLipidGrams*fluidBW/1000/fluidLipidSpec[fluidLipidType].density/fluidLipidBestHour).toFixed(1); //由best hour還原速率
      fluidLipidTotalVolume = fluidLipidRate*fluidLipidBestHour; //由best hour還原總量
      

      //計算fluid other in I/O 總量
      let fluidOtherInIOTotalVolume = 0;
      for (let i = 0; i < fluidOtherInIO.length; i++) {
        let eachVolume = parseExpression(fluidOtherInIO[i].value) || 0;
        //算總量
        fluidOtherInIOTotalVolume += eachVolume;
        // base value 用於計算Na intake
        let baseValue = fluidOtherInIOBase[i].value;
        if (baseValue === "3% NaCl") { fluidTotalNa += eachVolume*77/1000;} // 3% NaCl 1000ml = 77mEq Na
      }
      console.log(`Other in I/O: ${fluidOtherInIOTotalVolume} ml/day`);

      //計算fluid Other Solution總量
      let fluidOtherSolutionTotalVolume = 0;
      for (let i = 0; i < fluidOtherSolutionBase.length; i++) {
        //先算總量
        let rateValue = parseExpression(fluidOtherSolutionRate[i].value) || 0;
        fluidOtherSolutionTotalVolume += rateValue*24;
        //再算成分
        let baseValue = fluidOtherSolutionBase[i].value;
        if      (baseValue === "L/R" ) { fluidTotalNa = rateValue*24/1000*130; } // L/R 1000ml = 130mEq Na
        else if (baseValue === "H/S" ) { fluidTotalNa = rateValue*24/1000*77 ; } // H/S 1000ml = 77mEq Na
        else if (baseValue === "N/S" ) { fluidTotalNa = rateValue*24/1000*154; } // N/S 1000ml = 154mEq Na
        else if (baseValue === "D/W" ) { }
        else if (baseValue === "D5W" ) { }
        else if (baseValue === "D10W") { }
      }
      console.log(`Total Other Solution: ${fluidOtherSolutionTotalVolume} ml/day`);
      
      //計算fluid Regular IV and TPN
      let fluidTPNRate = 0;
      let fluidTPNTotalVolume = 0;
      let fluidRegularIVTotalVolume = 0;
      let fluidTPNMakeUp = "";

      //fluidTPNGrams有值，表示非補不足，先計算TPN再計算普通IV流速
      if (fluidTPNGrams || fluidTPNGrams === 0){ 
        fluidTPNGrams = fluidTPNGrams || 0;
        fluidTPNRate = (fluidTPNGrams*fluidBW/1000/fluidTPNAA/fluidTPNHours).toFixed(1);
        fluidTPNTotalVolume = fluidTPNRate*fluidTPNHours;

        //計算普通IV流速
        fluidRegularIVRate = ((fluidTotalTDF-fluidTotalPO-fluidTPNTotalVolume-fluidLipidTotalVolume-fluidOtherInIOTotalVolume-fluidOtherSolutionTotalVolume)/24).toFixed(1);
        fluidRegularIVTotalVolume = fluidRegularIVRate*24;
      } else { 
        //未設定tpn gram數，表示補不足，先計算普通IV流速再計算TPN
        fluidRegularIVTotalVolume = (fluidRegularIVRate*24).toFixed(1);
        fluidTPNTotalVolume = fluidTotalTDF-fluidTotalPO-fluidLipidTotalVolume-fluidOtherInIOTotalVolume-fluidOtherSolutionTotalVolume-fluidRegularIVTotalVolume;
        fluidTPNRate = (fluidTPNTotalVolume/fluidTPNHours).toFixed(1);
        fluidTPNGrams = (fluidTPNRate*24*fluidTPNAA/(fluidBW/1000)).toFixed(2);
        fluidTPNMakeUp = " (補)";
      }
      console.log(`Regular IV: ${fluidRegularIVRate} ml/hr`);
      console.log(`TPN ${fluidTPNGrams} g/kg/day = ${fluidTPNRate} ml/hr run ${fluidTPNHours} hrs`);
      console.log("***************結束水分計算***************")
                   
      // *****************************************
      //           將計算結果轉成文字輸出
      // *****************************************
      console.log("***************開始文字輸出***************")
      let fluidOrderArray = [];
      // BW: ? g
      let fluidOrderOutputBW = fluidBW === 0 ? "BW:" : `BW: ${fluidBW} g`;
      fluidOrderArray.push(fluidOrderOutputBW);
      console.log(`BW: ${fluidOrderOutputBW}`);

      // TDF: ? ml/kg/day = total ? ml/day
      let fluidOrderOutputTDF = fluidTDF === 0 ? "Total daily fluid:" : `Total daily fluid: ${fluidTDF} ml/kg/day = total ${fluidTotalTDF} ml/day`;
      fluidOrderArray.push(fluidOrderOutputTDF);
      console.log(`Total daily fluid: ${fluidOrderOutputTDF}`);

      // PO: Diet: ? ml/day
      let fluidOrderOutputPO = "";
      const fluidPOPattern = /^(\d+\s*\*\s*\d+)(\s*\+\s*\d+\s*\*\s*\d+)*$/; // "A*B + C*D + E*F ...", where A B ... are numbers  
      if (fluidPO == "") { fluidOrderOutputPO = "";} 
      else if (fluidPO === 0) { fluidOrderOutputPO = "Diet: NPO with OG decompression";} //若輸入為0則NPO
      else if (!fluidPOPattern.test(fluidPO)) { console.log("Invalid PO format"); fluidOrderOutputPO = `Diet: ${fluidTotalPO} ml/day`;}
      else {

        //抓出PO裡面的數字組合 A*B + C*D + E*F ... 
        const fluidPOComponentsPattern = /(\d+)\s*\*\s*(\d+)/g; // match all A*B, where A B are numbers
        let fluidPOComponentsMatch;
        let fluidPOComponentsPairs = [];
        while ((fluidPOComponentsMatch = fluidPOComponentsPattern.exec(fluidPO)) !== null) {
          const [_, base, multiplier] = fluidPOComponentsMatch;
          fluidPOComponentsPairs.push({ base: parseInt(base), multiplier: parseInt(multiplier) });
        }
        
        // 計算總共幾餐 = Q?H feeding, ? = 24/總餐數
        let fluidPOMultiplierSum = fluidPOComponentsPairs.reduce((sum, item) => sum + item.multiplier, 0);
        if (24 % fluidPOMultiplierSum !== 0) { fluidOrderOutputPO = `Diet: ${fluidTotalPO} ml/day`; } //若不能整除24則直接輸出總量
        else{
          fluidOrderOutputPO = fluidPOComponentsPairs.map(({ base, multiplier }) => `${base}ml * ${multiplier} meals`).join(" then ");
          fluidOrderOutputPO.split(" then ").slice(0, -1).join(" then "); //移除最後一個元素 (最後一個*幾餐)
          fluidOrderOutputPO += ` / Q${24/fluidPOMultiplierSum}H`;  //加上餵食頻率
          // 加上奶品
          let fluidPOMilkType = fluidPOHM && fluidPOFormula ?  `${fluidPOHM}/${fluidPOFormula}` : fluidPOHM || fluidPOFormula || '';
          fluidOrderOutputPO = fluidPOMilkType ? `${fluidPOMilkType} ${fluidOrderOutputPO}` : fluidOrderOutputPO;
          // 加上PO總量
          fluidOrderOutputPO = `Diet: ${fluidOrderOutputPO} = (total ${fluidTotalPO}ml/day )`;
        }
      }
      fluidOrderArray.push(fluidOrderOutputPO);
      console.log(`Diet: ${fluidOrderOutputPO}`);     

      // TPN: ? g/kg/day = ? ml/hr run ? hrs
      let fluidOrderOutputTPNHours = fluidTPNHours ===24? "":`run ${fluidTPNHours}hrs`;
      let fluidOrderOutputTPN = `${fluidTpnAAMap[fluidTPNAA]}${fluidTPNMakeUp} ${fluidTPNGrams}g/kg/day=${fluidTPNRate}ml/hr ${fluidOrderOutputTPNHours}`;
      fluidOrderOutputTPN = fluidTPNGrams==0 ? "":fluidOrderOutputTPN;
      fluidOrderOutputTPN = fluidBW > 0 ? fluidOrderOutputTPN : ""; //若BW=0則不顯示TPN，避免出現NaN
      fluidOrderArray.push(fluidOrderOutputTPN);
      console.log(`TPN: ${fluidOrderOutputTPN}`);      

      // Lipid: ? g/kg/day = total ? g/day
      let fluidOrderOutputLipid = `${fluidLipidType} ${fluidLipidGrams}g/kg/day = ${fluidLipidRate} ml/hr run ${fluidLipidBestHour} hrs`;
      fluidOrderOutputLipid = fluidLipidGrams==0 ? "":fluidOrderOutputLipid;
      fluidOrderArray.push(fluidOrderOutputLipid);
      console.log(`Lipid: ${fluidOrderOutputLipid}`); 

      // Other in I/O: ? ml/day
      let fluidOrderOutputOtherInIO = fluidOtherInIOTotalVolume === 0 ? "" : `Other in I/O: ${fluidOtherInIOTotalVolume} ml/day`;
      fluidOrderArray.push(fluidOrderOutputOtherInIO);
      console.log(`Other in I/O: ${fluidOrderOutputOtherInIO} ml/day`);

      // other solution: ? ml/hr
      let fluidOrderOutputOtherSolution = fluidOtherSolutionTotalVolume === 0 ? "" : `Total Other Solution run ${(fluidOtherSolutionTotalVolume/24).toFixed(1)} ml/hr = ${fluidOtherSolutionTotalVolume.toFixed(1)} ml/day`;
      fluidOrderArray.push(fluidOrderOutputOtherSolution);
      console.log(`Total Other Solution: ${fluidOrderOutputOtherSolution}`);

      // Regular IV: ? ml/hr
      let fluidOrderOutputRegularIV = fluidRegularIVRate === 0 ? "" : `${fluidRegularIVType} run ${fluidRegularIVRate} ml/hr`;
      fluidOrderArray.push(fluidOrderOutputRegularIV);
      console.log(`Regular IV: ${fluidRegularIVRate} ml/hr`);

      console.log("***************結束文字輸出***************")
      console.log(fluidOrderArray.join("\n"));

      // *****************************************
      //           計算營養成分
      // *****************************************

      //計算GIR
      //let fluidGIR = 0;

      //已計算other in I/O離子
      //已計算other solution離子

      //計算TPN離子
      fluidTotalNa += fluidTPNTotalVolume/1000*fluidTPNNa;
      fluidTotalK  += fluidTPNTotalVolume/1000*fluidTPNK;
      fluidTotalCa += fluidTPNTotalVolume/1000*fluidTPNCa;
      fluidTotalP  += fluidTPNTotalVolume/1000*fluidTPNP;
      fluidTotalMg += fluidTPNTotalVolume/1000*fluidTPNMg;
      
      //計算regular IV離子
      if (fluidRegularIVType === "D0.225S(500)") fluidTotalNa += fluidRegularIVTotalVolume/1000*77; // D0.225S(500) 1000ml = 77mEq Na
      else if (fluidRegularIVType === "D0.225S(500) + 2PC D50W") fluidTotalNa += fluidRegularIVTotalVolume/1000*77; // D0.225S(500) 1000ml = 77mEq Na

      let fluidTotalNaPerKg = fluidBW > 0 ? (fluidTotalNa/(fluidBW/1000)).toFixed(1) : "___";
      let fluidTotalKPerKg  = fluidBW > 0 ? (fluidTotalK /(fluidBW/1000)).toFixed(1) : "___";
      let fluidTotalCaPerKg = fluidBW > 0 ? (fluidTotalCa/(fluidBW/1000)).toFixed(1) : "___";
      let fluidTotalPPerKg  = fluidBW > 0 ? (fluidTotalP /(fluidBW/1000)).toFixed(1) : "___";
      let fluidTotalMgPerKg = fluidBW > 0 ? (fluidTotalMg/(fluidBW/1000)).toFixed(1) : "___";


      // *****************************************
      //           將計算結果輸出到網頁
      // *****************************************
      
      //先將name=fluid_order_outputs的li都移除
      let fluidOrderOutputs = document.querySelectorAll('[name="fluid_order_outputs"]');
      fluidOrderOutputs.forEach(output => {
        output.remove();
      });      
      
      //在fluid_order_output下面新增一個節點，顯示計算結果
      let fluidOrderOutputDiv = document.getElementById('fluid_order_output');
      fluidOrderArray.forEach(order => {
        if (order) {
          fluidOrderOutputDiv.insertAdjacentHTML('afterend', `<li class="list-group-item copy-item" name="fluid_order_outputs" data-content="${order}">${order}</li>`);
          fluidOrderOutputDiv=fluidOrderOutputDiv.nextSibling; //移動到下一個節點
        }
      });

      //將GIR ?, Na ? mEq, K ? mmol, Ca ? mEq, P ? mmol, Mg mEq 輸出到網頁
      // document.getElementById('fluid_nutrition_GIR').textContent = `GIR`;
      // document.getElementById('fluid_nutrition_Kcal').textContent = `Kcal`;
      document.getElementById('fluid_nutrition_Na').textContent = `Na ${fluidTotalNaPerKg}`;
      document.getElementById('fluid_nutrition_K').textContent = `K ${fluidTotalKPerKg}`;
      document.getElementById('fluid_nutrition_Ca').textContent = `Ca ${fluidTotalCaPerKg}`;
      document.getElementById('fluid_nutrition_P').textContent = `P ${fluidTotalPPerKg}`;
      document.getElementById('fluid_nutrition_Mg').textContent = `Mg ${fluidTotalMgPerKg}`;
     
      //加入複製功能         
      document.querySelectorAll('.copy-item').forEach(item => {
        item.addEventListener('click', () => {
          const content = item.textContent.trim();  // 直接獲取文字內容
          navigator.clipboard.writeText(content).then(() => {
            console.log(`已複製: ${content}`);
          }).catch(err => {
            console.error('複製失敗:', err);
          });
        });
      });
    }


    // *****************************************
    // 計算GIR
    // *****************************************
    function calculateGIR(){
      //讀取輸入值
      const girBW = parseFloat(document.getElementById('GIR_BW').value) || 0;
      let girDex = document.querySelectorAll('[name="GIR_dex"]');
      let girRate = document.querySelectorAll('[name="GIR_rate"]');
      let girTotal = 0;
      for (let i = 0; i < girDex.length; i++) {
        let dex = parseFloat(girDex[i].value) || 0;
        let rate = parseFloat(girRate[i].value) || 0;
        girTotal += dex*rate;
      }

      girTotal = girTotal/(6*girBW/1000);

      //將GIR輸出到網頁
      document.getElementById('GIR_result').textContent = girTotal? `GIR ${girTotal.toFixed(2)}`:"GIR 0.0";
    }


    // *****************************************
    // 計算Dextrose濃度
    // *****************************************
    function calculateDex(){
      //讀取輸入值
      const dextroseOriginalConcentration = parseFloat(document.getElementById('dextrose_original_concentration').value) || 0;
      const dextroseOriginalAmount = parseFloat(document.getElementById('dextrose_original_amount').value) || 0;
      const dextroseAddConcentration = parseFloat(document.getElementById('dextrose_add_concentration').value) || 0;
      const dextroseAddAmount = parseFloat(document.getElementById('dextrose_add_amount').value) || 0;

      let dextroseConcentrationFinal = (dextroseOriginalConcentration/100*dextroseOriginalAmount + dextroseAddConcentration/100*dextroseAddAmount)/(dextroseOriginalAmount+dextroseAddAmount)*100;
      dextroseConcentrationFinal = dextroseConcentrationFinal > 0 ? dextroseConcentrationFinal.toFixed(2) : 0.00;

      
      //將Dextrose濃度輸出到網頁
      document.getElementById('dextrose_concentration_final').textContent = `Dextrose = ${dextroseConcentrationFinal} %`;
    }


    // *****************************************
    // 計算UA、UV深度
    // *****************************************
    function calculateUmbilicalCathLen(){
      //讀取輸入值
      const umbilicalCathLenBW = parseFloat(document.getElementById('umbilical_cath_len_BW').value) || 0;
      const umbilicalCathLenUAHigh = umbilicalCathLenBW > 0 ? (umbilicalCathLenBW/1000*3+9).toFixed(1) : "";
      const umbilicalCathLenUALow = umbilicalCathLenBW > 0 ? (umbilicalCathLenBW/1000+7).toFixed(1) : "";
      const umbilicalCathLenUV = umbilicalCathLenUAHigh > 0 ? (umbilicalCathLenUAHigh/2+1).toFixed(1) : "";
   
      //將UA、UV深度輸出到網頁
      document.getElementById('umbilical_cath_len_UA').textContent = umbilicalCathLenUAHigh? `高位 ${umbilicalCathLenUAHigh} cm, 低位 ${umbilicalCathLenUALow} cm`:"";
      document.getElementById('umbilical_cath_len_UV').textContent = umbilicalCathLenUV? `${umbilicalCathLenUV} cm`:"";
    }


    // *****************************************
    // 設定藥物資料
    // *****************************************
    const drugSpecs = {
      'Dopamine'      : { concentration: 40     , unit: 'mg/ml' , rateUnit: 'mcg/kg/min' , decimalPlace: 1},
      'Dobutamine'    : { concentration: 12.5   , unit: 'mg/ml' , rateUnit: 'mcg/kg/min' , decimalPlace: 1},
      'Milrinone'     : { concentration: 1      , unit: 'mg/ml' , rateUnit: 'mcg/kg/min' , decimalPlace: 1},
      'Epinephrine'   : { concentration: 1      , unit: 'mg/ml' , rateUnit: 'mcg/kg/min' , decimalPlace: 2},
      'Midazolam'     : { concentration: 5      , unit: 'mg/ml' , rateUnit: 'mcg/kg/min' , decimalPlace: 1},
      'Fentanyl'      : { concentration: 0.05   , unit: 'mg/ml' , rateUnit: 'mcg/kg/hr'  , decimalPlace: 3},
      'Bumetanide'    : { concentration: 0.25   , unit: 'mg/ml' , rateUnit: 'mcg/kg/hr'  , decimalPlace: 1},
      'Norepinephrine': { concentration: 1      , unit: 'mg/ml' , rateUnit: 'mcg/kg/min' , decimalPlace: 2},
      'Nicardipine'   : { concentration: 1      , unit: 'mg/ml' , rateUnit: 'mcg/kg/min' , decimalPlace: 1},
      'Nitroglycerin' : { concentration: 0.5    , unit: 'mg/ml' , rateUnit: 'mcg/kg/min' , decimalPlace: 2}, //小數點待確定
      'Labetalol'     : { concentration: 5      , unit: 'mg/ml' , rateUnit: 'mg/kg/hr'   , decimalPlace: 2}, //小數點待確定
      'PGE1'          : { concentration: 0.5    , unit: 'mg/ml' , rateUnit: 'mcg/kg/min' , decimalPlace: 2},
      'Vasopressin'   : { concentration: 20     , unit: 'U/ml'  , rateUnit: 'mU/kg/min'  , decimalPlace: 1},
      'Isoproterenol' : { concentration: 0.2    , unit: 'mg/ml' , rateUnit: 'mcg/kg/min' , decimalPlace: 1},
      'Rocuronium'    : { concentration: 10     , unit: 'mg/ml' , rateUnit: 'mcg/kg/min' , decimalPlace: 1},
      'Cisatracurium' : { concentration: 2      , unit: 'mg/ml' , rateUnit: 'mcg/kg/min' , decimalPlace: 1},
      'Morphine'      : { concentration: 10     , unit: 'mg/ml' , rateUnit: 'mcg/kg/min' , decimalPlace: 2}, //小數點待確定
      'Lorazepam'     : { concentration: 2      , unit: 'mg/ml' , rateUnit: 'mg/kg/hr'   , decimalPlace: 2}, //小數點待確定
      'Ketamine'      : { concentration: 50     , unit: 'mg/ml' , rateUnit: 'mcg/kg/min' , decimalPlace: 1},
      'Propofol'      : { concentration: 10     , unit: 'mg/ml' , rateUnit: 'mcg/kg/min' , decimalPlace: 2}, //小數點待確定
      'MgSO4'         : { concentration: 100    , unit: 'mg/ml' , rateUnit: 'mg/kg/hr'   , decimalPlace: 1},
      'Lidocaine'     : { concentration: 50     , unit: 'mg/ml' , rateUnit: 'mcg/kg/min' , decimalPlace: 2}  //小數點待確定
    };

    // *****************************************
    // 計算藥物配製
    // *****************************************
    function calculateDrugPreperation() {
      //讀取輸入值
      const drugBW = parseFloat(document.getElementById('drug_BW').value) || 0;
      const drugName = document.getElementById('drug_name').value;
      let drugExtractAmount = parseFloat(document.getElementById('drug_extract_amount').value) || 0;
      const drugDiluterName = document.getElementById('drug_diluter_name').value;
      const drugTotalFinalVolume = parseFloat(document.getElementById('drug_total_final_volume').value) || 0;
      const drugInfusionRate = parseFloat(document.getElementById('drug_infusion_rate').value) || 0;
      let drugInfusionFinalRate = parseFloat(document.getElementById('drug_infusion_final_rate').value) || 0;

      //取得藥物資料
      const drugSpec = drugSpecs[drugName];

      //更新網頁上顯示的藥物濃度單位
      document.getElementById('drug_name').title= `${drugName} ${drugSpec.concentration} ${drugSpec.unit}`;
      document.getElementById('drug_extract_amount_unit').textContent = (drugSpec.unit).replace("/ml","");
      document.getElementById('drug_infusion_final_rate_unit').textContent = drugSpec.rateUnit;

      //限制網頁上的輸入框，若drugExtractAmount>0則drugInfusionFinalRate不能輸入，反之亦然，若都沒有值則都可以輸入
      document.getElementById('drug_infusion_final_rate').disabled = drugExtractAmount > 0;
      document.getElementById('drug_extract_amount').disabled = drugInfusionFinalRate > 0;

      //重量單位換算
      let drugUnitConversionRatio = 1;
      const drugExtractAmountUnits = (drugSpec.unit).split("/"); // e.g. [0] = mg, [1] = ml
      const drugInfusionFinalRateUnits = (drugSpec.rateUnit).split("/"); // e.g. [0] = mcg, [1] = kg, [2] = min
      const drugUnitComb = `${drugExtractAmountUnits[0]}-${drugInfusionFinalRateUnits[0]}`;
      switch (drugUnitComb) {
        case 'mg-mcg': drugUnitConversionRatio = 1/1000; break;
        case 'U-mU'  : drugUnitConversionRatio = 1/1000; break;
        case 'mg-mg' : drugUnitConversionRatio = 1; break;
        default: drugUnitConversionRatio = 1; break;
      }

      //時間單位換算
      let drugTimeConversionRatio = 1;
      if (drugInfusionFinalRateUnits[2] === 'min') drugTimeConversionRatio = 60; // e.g. [0] = mcg, [1] = kg, [2] = min
      
      //若無drugExtractAmount, 用drugInfusionFinalRate回推; 反之亦然
      if (drugExtractAmount === 0) {
        drugExtractAmount = drugInfusionFinalRate * drugBW * drugUnitConversionRatio * drugTimeConversionRatio / drugInfusionRate * drugTotalFinalVolume.toFixed(drugSpec.decimalPlace);
        // drugInfusionFinalRate = drugInfusionFinalRate.toFixed(2);
      } else {
        drugInfusionFinalRate = (drugExtractAmount / drugTotalFinalVolume / drugBW / drugUnitConversionRatio / drugTimeConversionRatio * drugInfusionRate).toFixed(2);
        drugExtractAmount = drugExtractAmount.toFixed(drugSpec.decimalPlace);
      }
      
      //計算需要多少dilutor
      let drugDiluterAmount = ( drugTotalFinalVolume - drugExtractAmount / drugSpec.concentration ).toFixed(1);

      //計算pure line
      let drugPureLineFinalRate = ( 1 * drugSpec.concentration / drugUnitConversionRatio / drugBW / drugTimeConversionRatio).toFixed(1);

      //輸出成文字
      let drugTextForOrder = `${drugName} ${drugExtractAmount}${drugExtractAmountUnits[0]} in ${drugDiluterName} ${drugDiluterAmount}ml (total ${drugTotalFinalVolume}ml), run ${drugInfusionRate}ml/hr = ${drugInfusionFinalRate} ${drugSpec.rateUnit}`;
      let drugTextForMed = `${drugName} ${drugExtractAmount}${drugExtractAmountUnits[0]} in ${drugDiluterName} ${drugDiluterAmount}ml (total ${drugTotalFinalVolume}ml), run as order`;
      let drugTextForPureLine = `${drugName} pure line 1 ml/hr = ${drugPureLineFinalRate} ${drugSpec.rateUnit}`;

      //輸出到網頁
      if (drugBW && drugName && drugDiluterName && drugTotalFinalVolume && drugInfusionRate && (drugExtractAmount||drugInfusionFinalRate)) {
        document.getElementById('drug_text_for_order').textContent = drugTextForOrder;
        document.getElementById('drug_text_for_med').textContent = drugTextForMed;
        document.getElementById('drug_text_for_pure_line').textContent = drugTextForPureLine;
      } else {
        document.getElementById('drug_text_for_order').textContent = "醫囑";
        document.getElementById('drug_text_for_med').textContent = "藥囑";
        document.getElementById('drug_text_for_pure_line').textContent = "Pure Line";
      }
    }    


    // *****************************************
    // 計算常用antibiotics配置
    // *****************************************


    // *****************************************
    // 對傳入的文字進行解析並加減乘除
    // *****************************************
    function parseExpression(expression) {
      expression = expression.replace(/\s+/g, ""); // 移除掉多餘的空格
      expression = expression.replace(/[+\-*\/]$/, ""); // 移除結尾的 +, -, *, / 符號
      try {
        return math.evaluate(expression); // 使用 math.js 的 evaluate 方法計算表達式
      } catch (error) {
          console.error("Expression Error:", error);
          return 0; // 若計算過程中有錯誤，返回 0
      }
    }


    // *****************************************
    // 新增新的輸入行
    // *****************************************
    function addNewElement( referenceNode, typeOfElement) {
      // Get the parent of the reference node
      let parent = referenceNode.parentNode;     
      let grandParent = parent.parentNode;

      // Create a new row for the inputs
      let newDiv = document.createElement('div');
      newDiv.classList.add('input-group'); //加入屬性class
      switch(typeOfElement){
        case('fluid_other_solution'):
          newDiv.innerHTML = `
            <span class="input-group-text justify-content-center" style="width: 15%;">Other</span>
            <select name="fluid_other_solution_base" class="form-select text-center" onchange="calculateFluid()">
              <option value="" selected></option>
              <option value="D/W">D/W base</option>
              <option value="D5W">D5W base</option>
              <option value="D10W">D10W base</option>
              <option value="H/S">H/S base</option>
              <option value="N/S">N/S base</option>
              <option value="L/R">L/R base</option>
            </select>
            <input type="text" name="fluid_other_solution_rate" class="form-control text-center" oninput="calculateFluid()" />
            <span class="input-group-text justify-content-center" style="width:10%;">ml/hr</span>
            <button class="btn btn-light" style="border-color: #e0e3e7; width: 5%;" onclick="addNewElement(this, 'fluid_other_solution')">+</button>
          `;
          break;
        case('fluid_other_in_IO'):
          newDiv.innerHTML = `
            <span class="input-group-text justify-content-center" style="width: 15%;">Other</span>
            <select name="fluid_other_in_IO_base" class="form-select text-center" onchange="calculateFluid()">
              <option value="" selected></option>
              <option value="3% NaCl">3% NaCl</option>
            </select>
            <input type="text" name="fluid_other_in_IO" class="form-control text-center" oninput="calculateFluid()" />
            <span class="input-group-text justify-content-center" style="width:10%;">ml/day</span>
            <button class="btn btn-light" style="border-color: #e0e3e7; width: 5%;" onclick="addNewElement(this, 'fluid_other_in_IO')">+</button>
          `;
          break;
        case('GIR_dex'):
          newDiv.innerHTML = `
            <span class="input-group-text justify-content-center" style="width: 15%;">Dex</span>
            <input name="GIR_dex" type="number" class="form-control text-center" oninput="calculateGIR()">
            <span class="input-group-text">%</span>
            <input name="GIR_rate" type="text" class="form-control text-center" oninput="calculateGIR()">
            <span class="input-group-text" style="width: 10%;">ml/hr</span>
            <button class="btn btn-light" style="border-color: #e0e3e7; width: 5%;" onclick="addNewElement(this, 'GIR_dex')">+</button>
          `;
          break;
      }
      grandParent.insertBefore(newDiv, parent);
    }    


    // 頁面載入時先執行一次計算
    calculateFluid();
    calculateGIR();
    calculateDex();
    calculateUmbilicalCathLen();
    calculateDrugPreperation();

  </script>
</body>

</html>
